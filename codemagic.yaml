workflows:
  ios-diia-workflow:
    name: Ğ”Ñ–Ñ iOS Build (Ğ´Ğ»Ñ Sideloadly/AltStore)
    max_build_duration: 60
    instance_type: mac_mini_m1
    
    environment:
      vars:
        XCODE_PROJECT: "DiiaApp.xcodeproj"
        XCODE_SCHEME: "DiiaApp"
        BUNDLE_ID: "com.nutipov.diia"
      
      xcode: 15.0
      cocoapods: default
    
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: '*'
          include: true
    
    scripts:
      - name: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ÑĞ±Ğ¾Ñ€ĞºĞµ
        script: |
          set -e
          set -x
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‡ºğŸ‡¦ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ”Ñ–Ñ— Ğ´Ğ»Ñ Sideloadly/AltStore"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Bundle ID: $BUNDLE_ID"
          echo "Scheme: $XCODE_SCHEME"
          echo ""
          xcodebuild -version
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (Ğ±ĞµĞ· Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸)
        script: |
          set -e
          set -x
          
          echo "ğŸ“¦ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ ÑĞ±Ğ¾Ñ€ĞºÑƒ..."
          
          # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğµ ÑĞ±Ğ¾Ñ€ĞºĞ¸
          xcodebuild clean \
            -project "$XCODE_PROJECT" \
            -scheme "$XCODE_SCHEME"
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ°Ñ€Ñ…Ğ¸Ğ² Ğ‘Ğ•Ğ— code signing
          # Ğ­Ñ‚Ğ¾ Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»Ğ¸Ñ‚ Sideloadly/AltStore Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ·Ğ¶Ğµ
          xcodebuild archive \
            -project "$XCODE_PROJECT" \
            -scheme "$XCODE_SCHEME" \
            -archivePath "$HOME/build/DiiaApp.xcarchive" \
            -destination 'generic/platform=iOS' \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=NO
          
          echo "âœ… ĞÑ€Ñ…Ğ¸Ğ² ÑĞ¾Ğ·Ğ´Ğ°Ğ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!"
      
      - name: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ IPA Ğ´Ğ»Ñ Sideloadly/AltStore
        script: |
          set -e
          set -x
          
          echo "ğŸ“± Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ IPA Ñ„Ğ°Ğ¹Ğ»..."
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ IPA
          mkdir -p "$HOME/build/ipa"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ² Ğ°Ñ€Ñ…Ğ¸Ğ²Ğµ
          APP_PATH="$HOME/build/DiiaApp.xcarchive/Products/Applications/DiiaApp.app"
          
          if [ -d "$APP_PATH" ]; then
            echo "âœ… ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾: $APP_PATH"
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Payload Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ (ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚ Ğ´Ğ»Ñ iOS IPA)
            cd "$HOME/build"
            mkdir -p Payload
            
            # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ² Payload
            cp -r "$APP_PATH" Payload/
            
            # Ğ£Ğ¿Ğ°ĞºĞ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ² IPA
            echo "ğŸ“¦ Ğ£Ğ¿Ğ°ĞºĞ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ² IPA..."
            zip -r "$HOME/build/ipa/DiiaApp.ipa" Payload
            
            # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
            rm -rf Payload
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
            if [ -f "$HOME/build/ipa/DiiaApp.ipa" ]; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… IPA ÑĞ¾Ğ·Ğ´Ğ°Ğ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ“ Ğ Ğ°ÑĞ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ: $HOME/build/ipa/DiiaApp.ipa"
              echo "ğŸ“Š Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ñ„Ğ°Ğ¹Ğ»Ğ°:"
              ls -lh "$HOME/build/ipa/DiiaApp.ipa"
              echo ""
              echo "ğŸ“² Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°:"
              echo "   1. Ğ¡ĞºĞ°Ñ‡Ğ°Ğ¹ DiiaApp.ipa Ğ¸Ğ· Artifacts"
              echo "   2. ĞÑ‚ĞºÑ€Ğ¾Ğ¹ Sideloadly Ğ¸Ğ»Ğ¸ AltStore"
              echo "   3. ĞŸĞµÑ€ĞµÑ‚Ğ°Ñ‰Ğ¸ IPA Ğ¸ Ğ²Ğ²ĞµĞ´Ğ¸ ÑĞ²Ğ¾Ğ¹ Apple ID"
              echo "   4. Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! ğŸ‡ºğŸ‡¦"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            else
              echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: IPA Ğ½Ğµ Ğ±Ñ‹Ğ» ÑĞ¾Ğ·Ğ´Ğ°Ğ½"
              exit 1
            fi
          else
            echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ² Ğ°Ñ€Ñ…Ğ¸Ğ²Ğµ"
            echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°:"
            ls -la "$HOME/build/DiiaApp.xcarchive/Products/Applications/" || echo "Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°"
            exit 1
          fi
      
      - name: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°Ñ…
        script: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“± IPA Ñ„Ğ°Ğ¹Ğ»:"
          ls -lh "$HOME/build/ipa/" || echo "IPA Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
          echo ""
          echo "ğŸ“‚ ĞÑ€Ñ…Ğ¸Ğ²:"
          ls -lh "$HOME/build/DiiaApp.xcarchive" || echo "ĞÑ€Ñ…Ğ¸Ğ² Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    artifacts:
      - $HOME/build/ipa/*.ipa
      - $HOME/build/DiiaApp.xcarchive
    
    publishing:
      email:
        recipients:
          - nutipovottakvot@gmail.com
        notify:
          success: true
          failure: true
